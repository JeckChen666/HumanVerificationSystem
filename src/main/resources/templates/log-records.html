<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Log Records</title>
    <link rel="icon" href="/ico/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui-calendar/0.0.8/calendar.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui-calendar/0.0.8/calendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        .main.container {
            margin-top: 2em;
            margin-bottom: 2em;
        }

        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        /* 移动端响应式调整 */
        @media only screen and (max-width: 767px) {
            .ui.form .fields {
                flex-direction: column;
            }
            .ui.form .fields .field {
                width: 100% !important;
                margin-bottom: 1em;
            }
        }

        /* 确保表格和搜索区域宽度一致 */
        .table-container {
            overflow-x: auto;
            margin-top: 1em;
        }

        /* 调整表格底部控件样式 */
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1em;
            margin-bottom: 1em;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
        }

        .page-size-selector label {
            margin-right: 0.5em;
            margin-left: 0.5em;
        }
    </style>
</head>
<body>

<div class="ui main container">
    <h1 class="ui center aligned header">Log Records</h1>

    <!-- Search Form -->
    <form class="ui form" id="searchForm">
        <div class="four fields">
            <div class="field">
                <input type="text" name="sessionId" placeholder="Session ID">
            </div>
            <div class="field">
                <input type="text" name="ip" placeholder="IP Address">
            </div>
            <div class="field">
                <input type="text" name="url" placeholder="URL">
            </div>
            <div class="field">
                <input type="text" name="country" placeholder="Country">
            </div>
        </div>
        <div class="four fields">
            <div class="field">
                <input type="text" name="city" placeholder="City">
            </div>
            <div class="field">
                <input type="text" name="deviceInfo" placeholder="Device Info">
            </div>
            <div class="field">
                <input type="text" name="operation" placeholder="Operation">
            </div>
            <div class="field">
                <input type="text" name="firstVisit" placeholder="First Visit">
            </div>
        </div>
        <div class="three fields">
            <div class="field">
                <div class="ui calendar" id="startDate">
                    <div class="ui input left icon">
                        <i class="calendar icon"></i>
                        <input type="text" name="startDate" placeholder="Start Date" th:value="${#strings.isEmpty(startDate) ? '' : #dates.format(startDate, 'yyyy-MM-dd HH:mm:ss')}">
                    </div>
                </div>
            </div>
            <div class="field">
                <div class="ui calendar" id="endDate">
                    <div class="ui input left icon">
                        <i class="calendar icon"></i>
                        <input type="text" name="endDate" placeholder="End Date" th:value="${#strings.isEmpty(endDate) ? '' : #dates.format(endDate, 'yyyy-MM-dd HH:mm')}">
                    </div>
                </div>
            </div>
            <div class="field">
                <button type="button" id="searchButton" class="ui primary fluid button">Search</button>
            </div>
        </div>
    </form>

    <!-- Table Container -->
    <div class="table-container">
        <table class="ui celled table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Session ID</th>
                <th>IP</th>
                <th>URL</th>
                <th>Country</th>
                <th>City</th>
                <th>Device Info</th>
                <th>Operation</th>
                <th>First Visit</th>
                <th>Created At</th>
            </tr>
            </thead>
            <tbody id="logTable">
            <!-- Data will be populated here via AJAX -->
            </tbody>
        </table>
    </div>

    <!-- Table Footer -->
    <div class="table-footer">
        <div class="page-size-selector">
            <label>Show</label>
            <select class="ui dropdown" id="pageSize">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
            <label>entries per page</label>
        </div>
        <div class="ui pagination menu" id="pagination">
            <!-- Pagination will be generated here -->
        </div>
    </div>
</div>

<!-- Modal for full content -->
<div class="ui modal" id="contentModal">
    <div class="header">Full Content</div>
    <div class="content" id="modalContent"></div>
    <div class="actions">
        <div class="ui approve button">Close</div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Initialize Semantic UI components
        $('.ui.dropdown').dropdown();

        // Initialize calendar components
        $('#startDate').calendar({
            type: 'datetime',
            firstDayOfWeek: 1,
            ampm: false,
            endCalendar: $('#endDate'),
            formatter: {
                // 用于显示的时间格式
                datetime: function(date, settings) {
                    if (!date) return '';
                    return moment(date).format('YYYY-MM-DD HH:mm:ss');
                }
            }
        });

        $('#endDate').calendar({
            type: 'datetime',
            firstDayOfWeek: 1,
            ampm: false,
            startCalendar: $('#startDate'),
            formatter: {
                datetime: function(date, settings) {
                    if (!date) return '';
                    return moment(date).format('YYYY-MM-DD HH:mm:ss');
                }
            }
        });

        const $logTable = $('#logTable');
        const $pagination = $('#pagination');
        const $pageSize = $('#pageSize');
        let currentPage = 0;
        let totalItems = 0;
        let pageSize = $pageSize.val();

        function formatDateForRequest(dateStr) {
            if (!dateStr) return '';
            const date = moment(dateStr, 'YYYY-MM-DD HH:mm:ss');
            return date.isValid() ? date.format('YYYY-MM-DD HH:mm:ss') : '';
        }


        // function loadData(page = 0) {
        //     const formData = $('#searchForm').serializeArray();
        //     formData.push({ name: 'page', value: page });
        //     formData.push({ name: 'size', value: pageSize });
        //
        //     $.get('/api/log-records', formData, function(response) {
        //         $logTable.empty();
        //         response.data.forEach(record => {
        //             $logTable.append(`
        //             <tr>
        //                 <td><div class="truncate" data-full="${record.id}">${record.id}</div></td>
        //                 <td><div class="truncate" data-full="${record.sessionId}">${record.sessionId}</div></td>
        //                 <td><div class="truncate" data-full="${record.ip}">${record.ip}</div></td>
        //                 <td><div class="truncate" data-full="${record.url}">${record.url}</div></td>
        //                 <td><div class="truncate" data-full="${record.country}">${record.country}</div></td>
        //                 <td><div class="truncate" data-full="${record.city}">${record.city}</div></td>
        //                 <td><div class="truncate" data-full="${record.deviceInfo}">${record.deviceInfo}</div></td>
        //                 <td><div class="truncate" data-full="${record.operation}">${record.operation}</div></td>
        //                 <td><div class="truncate" data-full="${record.firstVisit}">${record.firstVisit}</div></td>
        //                 <td><div class="truncate" data-full="${record.createdAt}">${record.createdAt}</div></td>
        //             </tr>
        //         `);
        //         });
        //
        //         totalItems = response.totalItems;
        //         $pagination.empty();
        //
        //         // Add prev button
        //         $pagination.append(`
        //         <a class="item ${currentPage === 0 ? 'disabled' : ''}" data-page="${currentPage - 1}">
        //             <i class="left chevron icon"></i>
        //         </a>
        //     `);
        //
        //         // Add page numbers
        //         for (let i = 0; i < Math.ceil(totalItems / pageSize); i++) {
        //             $pagination.append(`
        //             <a class="item ${i === currentPage ? 'active' : ''}" data-page="${i}">
        //                 ${i + 1}
        //             </a>
        //         `);
        //         }
        //
        //         // Add next button
        //         $pagination.append(`
        //         <a class="item ${currentPage >= Math.ceil(totalItems / pageSize) - 1 ? 'disabled' : ''}" data-page="${currentPage + 1}">
        //             <i class="right chevron icon"></i>
        //         </a>
        //     `);
        //     });
        // }

        function loadData(page = 0) {
            // 获取表单数据
            const formData = {};
            $('#searchForm').serializeArray().forEach(item => {
                formData[item.name] = item.value;
            });

            // 格式化日期
            if (formData.startDate) {
                formData.startDate = formatDateForRequest(formData.startDate);
            }
            if (formData.endDate) {
                formData.endDate = formatDateForRequest(formData.endDate);
            }

            // 添加分页参数
            formData.page = page;
            formData.size = pageSize;

            // 发送POST请求
            $.ajax({
                url: '/api/log-records',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    $logTable.empty();
                    response.data.forEach(record => {
                        $logTable.append(`
                        <tr>
                            <td><div class="truncate" data-full="${record.id}">${record.id}</div></td>
                            <td><div class="truncate" data-full="${record.sessionId}">${record.sessionId}</div></td>
                            <td><div class="truncate" data-full="${record.ip}">${record.ip}</div></td>
                            <td><div class="truncate" data-full="${record.url}">${record.url}</div></td>
                            <td><div class="truncate" data-full="${record.country}">${record.country}</div></td>
                            <td><div class="truncate" data-full="${record.city}">${record.city}</div></td>
                            <td><div class="truncate" data-full="${record.deviceInfo}">${record.deviceInfo}</div></td>
                            <td><div class="truncate" data-full="${record.operation}">${record.operation}</div></td>
                            <td><div class="truncate" data-full="${record.firstVisit}">${record.firstVisit}</div></td>
                            <td><div class="truncate" data-full="${record.createdAt}">${record.createdAt}</div></td>
                        </tr>
                    `);
                    });

                    totalItems = response.totalItems;
                    $pagination.empty();

                    // Add prev button
                    $pagination.append(`
                    <a class="item ${currentPage === 0 ? 'disabled' : ''}" data-page="${currentPage - 1}">
                        <i class="left chevron icon"></i>
                    </a>
                `);

                    // Add page numbers
                    for (let i = 0; i < Math.ceil(totalItems / pageSize); i++) {
                        $pagination.append(`
                        <a class="item ${i === currentPage ? 'active' : ''}" data-page="${i}">
                            ${i + 1}
                        </a>
                    `);
                    }

                    // Add next button
                    $pagination.append(`
                    <a class="item ${currentPage >= Math.ceil(totalItems / pageSize) - 1 ? 'disabled' : ''}" data-page="${currentPage + 1}">
                        <i class="right chevron icon"></i>
                    </a>
                `);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading data:', error);
                    // 可以添加错误提示
                    $logTable.html('<tr><td colspan="10" class="center aligned">Error loading data</td></tr>');
                }
            });
        }


        // Handle search button click
        $('#searchButton').click(function() {
            currentPage = 0;
            loadData(currentPage);
        });

        // Handle pagination click
        $pagination.on('click', '.item:not(.disabled)', function() {
            currentPage = parseInt($(this).data('page'));
            loadData(currentPage);
        });

        // Handle page size change
        $pageSize.change(function() {
            pageSize = $(this).val();
            currentPage = 0;
            loadData(currentPage);
        });

        // Handle cell click to show modal
        $logTable.on('click', '.truncate', function() {
            const fullContent = $(this).data('full');
            $('#modalContent').text(fullContent);
            $('#contentModal').modal('show');
        });

        // Load initial data
        loadData();
    });
</script>

</body>
</html>